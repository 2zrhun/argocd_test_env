apiVersion: v1
kind: Secret
metadata:
  name: alertmanager-monitoring-kube-prometheus-alertmanager
  namespace: monitoring
  labels:
    app: kube-prometheus-stack-alertmanager
stringData:
  alertmanager.yaml: |
    global:
      resolve_timeout: 5m
      smtp_smarthost: 'smtp.gmail.com:587'
      smtp_require_tls: true

route:
      group_by: ['alertname', 'namespace']
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 4h
      receiver: 'email-default'
      routes:
      - match:
          severity: critical
        receiver: 'email-critical'
      - match_re:
          alertname: ^ArgoCD.*
        receiver: 'email-argocd'

receivers:
    - name: 'email-default'
      email_configs:
      - to: 'azarhounhamza@gmail.com'
        from: 'azarhounhamza@gmail.com'
        smarthost: 'smtp.gmail.com:587'
        auth_username: 'azarhounhamza@gmail.com'
        auth_password_file: '/etc/alertmanager/secrets/alertmanager-gmail-credentials/password'
        send_resolved: true
        headers:
          subject: '‚ö†Ô∏è [Alert] {{ .Status | toUpper }} - {{ .CommonLabels.alertname }}'

    - name: 'email-critical'
      email_configs:
      - to: 'azarhounhamza@gmail.com'
        from: 'azarhounhamza@gmail.com'
        smarthost: 'smtp.gmail.com:587'
        auth_username: 'azarhounhamza@gmail.com'
        auth_password_file: '/etc/alertmanager/secrets/alertmanager-gmail-credentials/password'
        send_resolved: true
        headers:
          subject: 'üö® [CRITICAL] {{ .CommonLabels.alertname }}'

    - name: 'email-argocd'
      email_configs:
      - to: 'azarhounhamza@gmail.com'
        from: 'azarhounhamza@gmail.com'
        smarthost: 'smtp.gmail.com:587'
        auth_username: 'azarhounhamza@gmail.com'
        auth_password_file: '/etc/alertmanager/secrets/alertmanager-gmail-credentials/password'
        send_resolved: true
        headers:
          subject: '‚öôÔ∏è [ArgoCD] {{ .CommonLabels.name }} - {{ .Status }}'
          
      templates: []
